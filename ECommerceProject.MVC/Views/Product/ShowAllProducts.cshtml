@using ECommerceProject.Application.DTOs.Category
@using ECommerceProject.MVC.ViewModels

@model IEnumerable<ProductDetailsVM>

@{
    ViewData["Title"] = "Products";
    var categories = ViewBag.Categories as List<GetCategoryDto> ?? new();
}

@Html.AntiForgeryToken()

<!-- ================= CATEGORY BAR ================= -->
<div class="container mb-4">
    <div class="d-flex align-items-center flex-wrap gap-2 category-bar">

        <!-- All -->
        <a href="#"
           class="category-pill category-btn category-all"
           data-category-id="0">
            All
        </a>

        <!-- Categories -->
        @foreach (var cat in categories)
        {
            <a href="#"
               class="category-pill category-btn"
               data-category-id="@cat.Id">
                @cat.Name
            </a>
        }
    </div>
</div>

<!-- ================= PRODUCTS ================= -->
<div class="container mt-4">
    <div id="productsContainer" class="row g-4">

        @foreach (var item in Model)
        {
            var prod = item.Product;

            var imageUrl = string.IsNullOrEmpty(prod.ImageUrl)
            ? Url.Content("~/images/no-image.png")
            : Url.Content($"~/Files/{prod.ImageUrl}");

            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card product-card h-100 shadow-sm">

                    <img src="@imageUrl"
                         class="card-img-top product-img"
                         alt="@prod.Name">

                    <div class="card-body d-flex flex-column">

                        <h6 class="card-title fw-bold text-truncate">
                            @prod.Name
                        </h6>

                        <p class="card-text text-muted small flex-grow-1">
                            @(prod.Description?.Length > 80
                                                    ? prod.Description.Substring(0, 80) + "..."
                                                    : prod.Description)
                    </p>

                        <div class="d-grid gap-2">

                            <a asp-controller="Product"
                               asp-action="ViewProduct"
                               asp-route-prodId="@prod.Id"
                               class="btn btn-outline-primary btn-sm">
                                View
                            </a>

                        @if (item.IsInCart)
                            {
                                <button class="btn btn-success btn-sm" disabled>
                                    Added to your cart
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-primary btn-sm add-to-cart-btn"
                                        data-product-id="@prod.Id"
                                        data-price="@prod.Price">
                                    Add to cart
                                </button>
                            }

                        </div>
                    </div>
                </div>
            </div>
        }

    </div>
</div>

<!-- ================= SCRIPTS ================= -->
@section Scripts {
    <script>
        /* ========= CATEGORY FILTER ========= */
        $(document).on("click", ".category-btn", function (e) {
            e.preventDefault();

            var categoryId = $(this).data("category-id");

            $.ajax({
                url: "/Product/FilterByCategoryAjax",
                type: "GET",
                data: { categoryId: categoryId },
                success: function (html) {
                    $("#productsContainer").html(html);
                },
                error: function () {
                    alert("Failed to load products");
                }
            });
        });

        /* ========= ADD TO CART ========= */
        $(document).on("click", ".add-to-cart-btn", function () {

            var btn = $(this);

            $.ajax({
                url: "/CartItem/AddToCartAjax",
                type: "POST",
                headers: {
                    "RequestVerificationToken":
                        $('input[name="__RequestVerificationToken"]').val()
                },
                data: {
                    productId: btn.data("product-id"),
                    quantity: 1,
                    unitPrice: btn.data("price")
                },
                success: function () {
                    btn
                      .removeClass("btn-primary")
                      .addClass("btn-success")
                      .text("Added to your cart")
                      .prop("disabled", true);
                },
                error: function () {
                    alert("Failed to add product to cart");
                }
            });
        });
    </script>
}
